<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>관리자 대시보드</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" th:href="@{/admin/dashboard/dashboard.css}" />
<link rel="stylesheet" th:href="@{/admin/lecture/allLecture.css}" />
<!-- 다이얼로그 용 라이브러리 -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
<script type="text/javascript">
$(function(){

	$("#stopDialog").dialog({
	    autoOpen: false,
	    modal: true,
	    width: 400,
	    buttons: {
	      "예": function () {
	        $(this).dialog("close");
	        var lectureId=$(".btn--ghost").val(); 
	        //ajax로 과목
	        $.ajax({
	        	url:"/admin/lecture/updateLectState",
	    		type:"GET",
	    		data:{lectureId: lectureId},
	    		error:function(xhr){
	    			alert(xhr.status);
	    		},
	    		success:function(html){
	    			
	    		}
	        });
	      },
	      "아니오": function () {
	        $(this).dialog("close");
	      }
	    }
	  });
	
	//중지 버튼 눌렀을 때
	$(".btn--ghost").click(function(){
		stopLect();
	});

	//공개 버튼 눌렀을 때
	$(".btn--primary").click(function(){
		showLect();
	});
});

function stopLect(){
	$("#stopDialog").dialog("open");
};

//카테고리 누를 때 변경하는 테이블 데이터
function lectByCategory(){
	//select 태그
	var categoryName=$("#category").val();
	
	$.ajax({
		url:"/admin/lecture/searchCategoryLect",
		type:"GET",
		data:{categoryName: categoryName},
		dataType:"json",
		error:function(xhr){
			alert(xhr.status);
		},
		success:function(data){
			var tbody = $("#lectureTableBody");
			tbody.empty();
			
			//데이터가 없으면 메시지 출력
			if (!data || data.length === 0) {
			    tbody.append('<tr><td colspan="8">데이터 없음</td></tr>');
			    return;
			}
			
			data.forEach(function(lect){
			    var statusHtml = lect.availability === 1
			      ? '<span class="open">공개</span>'
			      : '<span class="not-open">비공개</span>';

			    var row = `
			      <tr class="course-row">
			        <td class="course-thumb">
			          <img src="/common/images/${lect.thumbnail}" alt="">
			        </td>
			        <td class="course-title">${lect.lect_name}</td>
			        <td>${lect.score}</td>
			        <td>${lect.usercount}</td>
			        <td>${lect.inst_name}</td>
			        <td>${lect.total_profit}</td>
			        <td class="status status--open">${statusHtml}</td>
			        <td class="course-actions">
			          <button class="btn btn--primary" value="${lect.lect_id}">공개</button>
			          <button class="btn btn--ghost" value="${lect.lect_id}">중지</button>
			        </td>
			      </tr>
			    `;
			    tbody.append(row);
			  });
		}//success
	});//ajax
}
</script>
</head>
<body class="admin-dashboard">
  <div id="header">
    <th:block th:replace="~{fragments/adminHeader :: adminHeader}"></th:block>
  </div>

  <div class="admin-layout">
    <aside class="admin-sidebar">
      <th:block th:replace="~{fragments/adminSidebar :: adminSidebar}"></th:block>
    </aside>

	<!-- 좌측 상단 제목 -->
    <main class="admin-content">
      <section class="course-page">
        <header class="course-header">
          <h1>교육 과목 관리</h1>
        </header>

		<!-- 옵션 선택바 -->
        <div class="course-toolbar">
          <form id="cateName">
          <div class="course-filter">
            <label class="sr-only" for="category">카테고리</label>
            <select id="category" name="categoryName" onchange="lectByCategory()">
              <option value="">전체</option>
              <option th:each="category:${categoryList}"
               th:value="${category}" th:text="${category}" th:selected="${category == alsDTO.categoryName}">
              </option>
            </select>
          </div>
          </form>

		  <!-- 검색바 -->
          <div class="course-search">
            <input type="text" placeholder="강의명 / 강사 검색">
            <button type="button" id="search">검색</button>
          </div>
        </div>

		<!-- 테이블 내용 -->
        <table class="course-table">
          <thead>
            <tr>
              <th>이미지</th>
              <th>강의명</th>
              <th>평점</th>
              <th>총 수강생</th>
              <th>강사</th>
              <th>총 수입</th>
              <th>상태</th>
              <th>관리</th>
            </tr>
          </thead>
          <tbody id="lectureTableBody">
            <tr class="course-row" th:each="lects : ${lectByCategory}" th:object="${lects}">
              <td class="course-thumb">
                <img th:src="@{'/common/images/'+*{thumbnail}}" alt="">
              </td>
              <td class="course-title" th:text="*{lect_name}"></td>
              <td th:text="*{score}"></td>
              <td th:text="*{usercount}"></td>
              <td th:text="*{inst_name}"></td>
              <td th:text="*{total_profit}"></td>
              <td class="status status--open">
              <span id="open" th:if="*{availability eq 1}">공개</span>
              <span id="not open" th:unless="*{availability eq 1}">비공개</span>
              </td>
              <td class="course-actions">
                <button class="btn btn--primary" th:value="*{lect_id}">공개</button>
                <button class="btn btn--ghost" th:value="*{lect_id}">중지</button>
              </td>
            </tr>
          </tbody>
        </table>
        
        <!-- 중지 눌렀을 때 다이얼로그 출력 -->
        <div id="stopDialog" title="강의 중지">
  			<p>해당 강의를 중지하시겠습니까?</p>
		</div>
      </section>
      
    </main>
  </div>
</body>
</html>
